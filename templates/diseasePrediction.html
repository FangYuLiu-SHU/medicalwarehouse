<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <title>病症预测页面</title>
<style type="text/css">
.file {
    display: inline-block;
    height: 38px;
    line-height: 38px;
    padding: 0 18px;
    background-color: #1E9FFF;
    color: #fff;
    white-space: nowrap;
    text-align: center;
    font-size: 14px;
    border: none;
    border-radius: 2px;
    cursor: pointer;

    /*position: relative;*/
    /*overflow: hidden;*/
    /*text-decoration: none;*/
    /*text-indent: 0;*/
}
.file input {
    position: absolute;
    font-size: 100px;
    right: 0;
    top: 0;
    opacity: 0;
}
.file:hover {
    background: #78C3F3;
    border-color: #78C3F3;
    color: #004974;
    text-decoration: none;
}
</style>
    <link rel="stylesheet" href="../static/layui/css/layui.css"/>
    <script src="../static/js/jquery.js"></script>
  </head>
  <body>
      <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
        <ul class="layui-tab-title">
          <li class="layui-this">脉搏预测</li>
          <li>脉搏预测准确率展示</li>
          <li>舌预测</li>
          <li>舌预测准确率展示</li>
          <li>肾预测</li>
          <li>肾预测准确率展示</li>
        </ul>
        <div class="layui-tab-content" style="height: 100px;">
          <div class="layui-tab-item layui-show">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 15px;">
              <legend>输入病人的各项指标</legend>
            </fieldset>
            <form name="myForm" id="form1" class="layui-form layui-form-pane" action="##" onsubmit="return false" method="post" lay-filter="forecastInformation"
                  enctype='multipart/form-data'>

              <div class="layui-form-item" pane="">
                <label class="layui-form-label">性别</label>
                <div class="layui-input-block">
                  <input type="radio" name="sex" value="男" title="男" checked="">
                  <input type="radio" name="sex" value="女" title="女">
                  <!--<input type="radio" name="sex" value="禁" title="禁用" disabled="">-->
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-inline">
                  <label class="layui-form-label">年龄</label>
                  <div class="layui-input-inline">
                    <input type="text" name="userage" lay-verify="userAge" autocomplete="off" placeholder="请输入年龄" class="layui-input">
                  </div>
                </div>
                <div class="layui-inline">
                  <label class="layui-form-label">分期</label>
                  <div class="layui-input-inline">
                    <input type="text" name="stage" autocomplete="off" placeholder="请输入分期" class="layui-input">
                  </div>
                </div>
                <div class="layui-inline">
                  <label class="layui-form-label">血肌酐</label>
                  <div class="layui-input-inline">
                    <input type="text" name="bloodCreatinine" autocomplete="off" placeholder="请输入血肌酐指标"
                           lay-verify="userBloodCreatinine" class="layui-input">
                  </div>
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-inline">
                  <label class="layui-form-label">eGFR值</label>
                  <div class="layui-input-inline">
                    <input type="text" name="egfr" lay-verify="required" lay-reqtext="eGFR值不能为空" autocomplete="off"
                           placeholder="请先计算eGFR值" class="layui-input">
                  </div>
                </div>
                <div class="layui-inline">
                  <button type="button" class="layui-btn layui-btn-normal" id="LAY-component-form-egfr">计算eGFR值</button>
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-inline">
                  <label class="layui-form-label">脉搏表格</label>
                  <div class="layui-input-inline">
                    <input type="text" name="fileName" id="selectFileName" lay-verify="fileName"
                           lay-reqtext="请先选择脉搏数据文件" autocomplete="off" placeholder="未选择文件" class="layui-input"
                           readonly="readonly">
                  </div>
                </div>
                <div class="layui-inline">
                  <!--					<input type="file" name="pulseFile" class="file">-->
                  <a href="javascript:;" class="file">点击选择文件
                    <input type="file" name="pulseFile" id="selectFile" class="file">
                  </a>
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-inline">
                  <label class="layui-form-label">脉搏类型</label>
                  <div class="layui-input-inline">
                    <input type="text" name="pulseType" id="pulseType" autocomplete="off" placeholder="预测结果"
                           class="layui-input">
                  </div>
                </div>
                <div class="layui-inline">
                  <button class="layui-btn" id="commit" lay-submit="*" lay-filter="forecastInformation"
                          id="LAY-component-form-result">脉搏类型预测
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="layui-tab-item">
            <div id="container" style="width:100px;height:100px;position: absolute; left: 0; top: 0; right: 0; bottom: 0;margin: auto;"></div>
            <form name="myForm2" id="form2" class="layui-form layui-form-pane" action="##" onsubmit="return false"
                  method="post" lay-filter="selectNumber" enctype='multipart/form-data'>
              <div class="layui-form-item">
                <label class="layui-form-label">验证表格数</label>
                <div class="layui-input-inline">
                  <select name="selectNumber" lay-verify="required" lay-filter="selectNum" class="select">
                    <option value="50" selected="selected">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                  </select>
                </div>
              </div>
            </form>
            <div id="pulsePredictChartDom" style="width: 30%; height: 500%;float: left"></div><!--症状统计-->
            <div id="pulsePredictChartBar" style="width: 70%; height: 500%;float: right"></div><!--验证详情-->
          </div>
          <div class="layui-tab-item">内容3</div>
          <div class="layui-tab-item">内容4</div>
          <div class="layui-tab-item">内容5</div>
          <div class="layui-tab-item">内容6</div>
        </div>
      </div>
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/jquery.js"></script>
    <script type="text/javascript" src="../static/js/echarts.js"></script>
    <script type="text/javascript" src="../static/js/echarts.min.js"></script>
    <script>
    layui.use('element', function(){
      var $ = layui.jquery
      ,element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
       $('.layui-tab-title').on('click', function(title) {
          if(title.toElement.textContent=="脉搏预测准确率展示"){
            // var data = { "postData": "data" };
            var maindiv=document.getElementById('container')
            var myChart = echarts.init(maindiv);
            myChart.showLoading();
            $.ajax({
                url: "pulsePrediction_accuracy",
                type: "POST",
                dataType : "json",
                // processData: false,
                // contentType:false,
                // data: $('#form1').serialize(),
                data: {"selectTestNum": "50" },
                success: function (newData) {
                  myChart.hideLoading();
                  var pulsePredict_dom = document.getElementById('pulsePredictChartDom');
                  var pulsePredict_chart = echarts.init(pulsePredict_dom);
                  var pulsePredict_option={
                    title: {
                        text: '脉搏预测验证情况分布',
                        subtext: newData.testNum+'个脉搏验证表格',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                    },
                    series: [
                        {
                            name: '预测准确率'+newData.accuracy*100+'%',
                            type: 'pie',
                            radius: '60%',
                          label: {
                                normal: {
                                    position:"inner",
                                    show:false,
                                }
                            },
                            data: [
                                {value: newData.num_pos, name: '预测正确' },
                                {value: newData.num_neg, name: '预测错误' },
                            ],
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0,0,0,0.5)'
                                }
                            }
                        }
                    ]
                  };
                  pulsePredict_chart.setOption(pulsePredict_option);

                  var pulsePredict_bar = document.getElementById('pulsePredictChartBar');
                  var pulsePredict_chartBar = echarts.init(pulsePredict_bar);
                  var pulsePredictBar_option = {
                    title: {
                      text: '脉搏预测验证',
                      subtext: '验证详情',
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#283b56'
                            }
                        },
                        formatter : function(params){
                          var a=params[0];
                          var b=params[1];
                          var str='编号：'+a.axisValue;
                          str += '<br /><span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;left:5px;background-color:'+a.color+'"></span>' + a.seriesName + " : " + a.value + "<br />";
                          str += '<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;left:5px;background-color:'+b.color+'"></span>' + b.seriesName + " : " + b.value;
                          return str;
                        }
                    },
                    legend: {
                        data:['预测类别', '标签类别']
                    },
                    dataZoom: {
                        show: false,
                        start: 0,
                        end: 100
                    },
                    xAxis:
                    {
                      name:'脉搏表格编号',
                      nameLocation:'end',
                        type: 'category',
                        boundaryGap: true,
                        data: newData.idSet
                    },
                    yAxis:
                    {
                      name:'脉搏类型',
                      nameLocation:'end',
                        type: 'category',
                        boundaryGap: false,
                        data: ['', '沉细', '细', '弦', '弦细', '滑', '濡']
                    },
                    series: [
                        {
                            name: '标签类别',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: newData.labelType
                        },
                        {
                            name: '预测类别',
                            type: 'line',
                            data: newData.predictType
                        }
                    ]
                  };
                  pulsePredict_chartBar.setOption(pulsePredictBar_option);
                },
                error: function () {
                  layer.msg('处理出错！', { icon: 7, time: 2000, shade: [0.6, '#000', true] });
                }
            });
          }else if(title.toElement.textContent=="B标题"){
            alert(title.toElement.textContent);
          }else if(title.toElement.textContent=="C标题"){
            alert(title.toElement.textContent);
          }
       });

      //触发事件
      
      $('.site-demo-active').on('click', function(){
        var othis = $(this), type = othis.data('type');
        active[type] ? active[type].call(this, othis) : '';
        console.log(1111)
      });

      //Hash地址的定位
      var layid = location.hash.replace(/^#test=/, '');
      element.tabChange('test', layid);

      element.on('tab(test)', function(elem){
        location.hash = 'test='+ $(this).attr('lay-id');
        console.log(1444)
      });

    });
    </script>
    <script>
    layui.use(['form', 'layedit', 'laydate'], function(){
      var form = layui.form
      ,layer = layui.layer
      ,layedit = layui.layedit
      ,laydate = layui.laydate;

      //日期
      laydate.render({
        elem: '#date'
      });
      laydate.render({
        elem: '#date1'
      });

      //创建一个编辑器
      var editIndex = layedit.build('LAY_demo_editor');

      //自定义验证规则
      form.verify({
        userAge: function(value){
          var re = /^[0-9]+.?[0-9]*$/;
          if (!re.test(value)){
            return '输入的年龄不是数字！';
          }
          if(value<=0||value>120){
            return '请输入正确的年龄！';
          }
        }
        ,pass: [
          /^[\S]{6,12}$/
          ,'密码必须6到12位，且不能出现空格'
        ]
        ,userBloodCreatinine: function(value){
          var re = /^[0-9]+.?[0-9]*$/;
          if (!re.test(value)){
            return '请输入正确的血肌酐指标值！';
          }
        }
        ,fileName: function (value){
          if(value.length <= 0)
            return '请先选择脉搏数据文件';
        }
      });

      //监听指定开关
      form.on('switch(switchTest)', function(data){
        layer.msg('开关checked：'+ (this.checked ? 'true' : 'false'), {
          offset: '6px'
        });
        layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
      });

      //监听提交
      form.on('submit(forecastInformation)', function(data){
        var submitData = new FormData($("#form1")[0]);
        $.ajax({
            url: "disease_prediction",
            type: "POST",
            dataType : "json",
            processData: false,
            contentType:false,
            // data: $('#form1').serialize(),
            data:submitData,
            success: function (newData) {
              if(newData.fileRead=='success'){
                form.val('forecastInformation', {
                  "pulseType": newData.pulseType.toString()
                });
              }
              else if(newData.fileRead=='fail'){
                layer.msg('导入csv文件行列小于2560*57，或文件编码格式不是\'utf-16 le\'和\'utf-8\'', { icon: 7, time: 4000, shade: [0.6, '#000', true] });
              }
            },
            error: function () {
              layer.msg('处理出错！', { icon: 7, time: 2000, shade: [0.6, '#000', true] });
            }
        });
        // layer.alert(JSON.stringify(data.field), {
        //   title: '最终的提交信息'
        // })
        // alert(data);
        return false;
      });

      //表单赋值
      layui.$('#LAY-component-form-setval').on('click', function(){
        form.val('example', {
          "username": "贤心" // "name": "value"
          ,"password": "123456"
          ,"interest": 1
          ,"like[write]": true //复选框选中状态
          ,"close": true //开关状态
          ,"sex": "女"
          ,"desc": "我爱 layui"
        });
      });

      //表单取值
      layui.$('#LAY-component-form-getval').on('click', function(){
        var data = form.val('example');
        alert(JSON.stringify(data));
      });

      //利用表单已填信息计算eGFR值
      layui.$('#LAY-component-form-egfr').on('click', function(){
        var data = form.val('forecastInformation');
        var jsonData = JSON.stringify(data);// 转成JSON格式
        //var result = $.parseJSON(jsonData);// 转成JSON对象
        var objectData = JSON.parse(jsonData);//转成JSON对象
        if(objectData.userage==""){
          layer.msg('请输入年龄用于计算！', { icon: 7, time: 1000, shade: [0.6, '#000', true] });
          return ;
        }
        var re = /^[0-9]+.?[0-9]*$/;//数字判断验证规则
        age=parseFloat(objectData.userage);
        if (age==NaN || !re.test(age)){
          layer.msg('输入的年龄非正常数字！', { icon: 7, time: 1000, shade: [0.6, '#000', true] });
          return ;
        }
        if(age<0||age>120){
          layer.msg('年龄超出正常范围！', { icon: 7, time: 1000, shade: [0.6, '#000', true] });
          return ;
        }
        if(objectData.bloodCreatinine==""){
          layer.msg('请输入血肌酐值用于计算！', { icon: 7, time: 1000, shade: [0.6, '#000', true] });
          return ;
        }
        bloodCreatinine=parseFloat(objectData.bloodCreatinine);
        if (bloodCreatinine==NaN || !re.test(bloodCreatinine)){
          layer.msg('请输入正确的血肌酐指标值！', { icon: 7, time: 1000, shade: [0.6, '#000', true] });
          return ;
        }
        var egfr = 0;
        if(objectData.sex.toString()=="男"){
          egfr=186*(objectData.bloodCreatinine/88.41)**-1.154*(objectData.userage**-0.203)*1.233;
        }
        else if(objectData.sex.toString()=="女"){
          egfr=186*(objectData.bloodCreatinine/88.41)**-1.154*0.742*(objectData.userage**-0.203)*1.233;
        }
        //alert(jsonData);
        //alert(objectData.userage);//获取某key的对应value
        //alert(JSON.stringify(data));
        //更新计算得到的结果
        form.val('forecastInformation', {
          "sex": objectData.sex.toString() // "name": "value"
          ,"userage": objectData.userage.toString()
          ,"stage": objectData.stage.toString()
          ,"bloodCreatinine": objectData.bloodCreatinine.toString()
          ,"egfr": egfr.toString()
        });
      });
      //layui框架渲染（否则下拉框不显示）
      layui.use('form', function () {
          var form = layui.form;
          form.render();
          //更新数据
          var newData = {{newData | tojson}};//获取后端返回的结果
          objectData = JSON.parse(newData);
          //alert(objectData.pulseType.toString());
          //document.getElementById("pulseType").innerText = objectData.pulseType.toString();
          if(objectData.fileRead=='success'){
            form.val('forecastInformation', {
            "sex": objectData.sex.toString() // "name": "value"
            ,"userage": objectData.userage.toString()
            ,"stage": objectData.stage.toString()
            ,"bloodCreatinine": objectData.bloodCreatinine.toString()
            ,"egfr": objectData.egfr.toString()
            ,"fileName" : objectData.fileName.toString()
            ,"pulseType": objectData.pulseType.toString()
            });
          }
          else if(objectData.fileRead=='fail'){
            form.val('forecastInformation', {
            "sex": '男' // "name": "value"
            ,"userage": ''
            ,"stage": ''
            ,"bloodCreatinine": ''
            ,"egfr": ''
            ,"fileName" : ''
            ,"pulseType": ''
            });
            layer.msg('导入csv文件行列小于2560*57，或文件编码格式不是\'utf-16 le\'和\'utf-8\'', { icon: 7, time: 4000, shade: [0.6, '#000', true] });
          }
      });
    });
    </script>
    <script>
    $(".file").on("change","input[type='file']",function(){
      var fileNameText=document.getElementById("selectFileName");
      var fileInput=document.getElementById("selectFile");
      fileNameText.value=fileInput.files[0].name;
      //alert(fileNameText.placeholder);
    })
    </script>
      <script>
        layui.use(['element', 'form'], function () {
          var $ = layui.jquery
          var element = layui.element;
          var form = layui.form;
          var layer = layui.layer;
          form.on('select(selectNum)', function (data) {
            var postData={"selectTestNum": "50" };
            var message = data.value;
            if(message == "50"){
              postData={"selectTestNum": "50" };
            }
            else if (message == "100") {
              postData={"selectTestNum": "100" };
            } else if (message == "200") {
              postData={"selectTestNum": "200" };
            }
            var maindiv=document.getElementById('container')
            var myChart = echarts.init(maindiv);
            myChart.showLoading();
            $.ajax({
                url: "pulsePrediction_accuracy",
                type: "POST",
                dataType : "json",
                // processData: false,
                // contentType:false,
                // data: $('#form1').serialize(),
                data: postData,
                success: function (newData) {
                  myChart.hideLoading();
                  var pulsePredict_dom = document.getElementById('pulsePredictChartDom');
                  var pulsePredict_chart = echarts.init(pulsePredict_dom);
                  var pulsePredict_option={
                    title: {
                        text: '脉搏预测验证情况分布',
                        subtext: newData.testNum+'个脉搏验证表格',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                    },
                    series: [
                        {
                            name: '预测准确率'+newData.accuracy*100+'%',
                            type: 'pie',
                            radius: '60%',
                          label: {
                                normal: {
                                    position:"inner",
                                    show:false,
                                }
                            },
                            data: [
                                {value: newData.num_pos, name: '预测正确' },
                                {value: newData.num_neg, name: '预测错误' },
                            ],
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0,0,0,0.5)'
                                }
                            }
                        }
                    ]
                  };
                  pulsePredict_chart.setOption(pulsePredict_option);

                  var pulsePredict_bar = document.getElementById('pulsePredictChartBar');
                  var pulsePredict_chartBar = echarts.init(pulsePredict_bar);
                  var pulsePredictBar_option = {
                    title: {
                      text: '脉搏预测验证',
                      subtext: '验证详情',
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#283b56'
                            }
                        },
                        formatter : function(params){
                          var a=params[0];
                          var b=params[1];
                          var str='编号：'+a.axisValue;
                          str += '<br /><span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;left:5px;background-color:'+a.color+'"></span>' + a.seriesName + " : " + a.value + "<br />";
                          str += '<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;left:5px;background-color:'+b.color+'"></span>' + b.seriesName + " : " + b.value;
                          return str;
                        }
                    },
                    legend: {
                        data:['预测类别', '标签类别']
                    },
                    dataZoom: {
                        show: false,
                        start: 0,
                        end: 100
                    },
                    xAxis:
                    {
                      name:'脉搏表格编号',
                      nameLocation:'end',
                        type: 'category',
                        boundaryGap: true,
                        data: newData.idSet
                    },
                    yAxis:
                    {
                      name:'脉搏类型',
                      nameLocation:'end',
                        type: 'category',
                        boundaryGap: false,
                        data: ['', '沉细', '细', '弦', '弦细', '滑', '濡']
                    },
                    series: [
                        {
                            name: '标签类别',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: newData.labelType
                        },
                        {
                            name: '预测类别',
                            type: 'line',
                            data: newData.predictType
                        }
                    ]
                  };
                  pulsePredict_chartBar.setOption(pulsePredictBar_option);
                },
                error: function () {
                  layer.msg('处理出错！', { icon: 7, time: 2000, shade: [0.6, '#000', true] });
                }
            });
          });
        });
      </script>
  </body>
</html>